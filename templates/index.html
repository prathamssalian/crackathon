<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üåç Community Needs Platform</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
    background: linear-gradient(135deg, #6dd5ed, #2193b0);
    color: #333;
    min-height: 100vh;
    font-family: 'Poppins', sans-serif;
}
.container {
    background: #fff;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0px 10px 25px rgba(0,0,0,0.2);
    margin-top: 30px;
}
#map { height: 400px; margin-bottom: 20px; border-radius: 10px; }
.btn-primary, .btn-warning, .btn-danger {
    border-radius: 50px;
    font-weight: bold;
}
.btn-primary { background: #2193b0; border: none; color:#fff; }
.btn-primary:hover { background: #17677e; }
.btn-warning { background: #ffcc00; color: #000; }
.btn-danger { background: #ff4444; color: #fff; }
.card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
.card:hover { transform: translateY(-5px); box-shadow: 0px 10px 25px rgba(0,0,0,0.2); }
h1 { color: #2193b0; }
.form-control { border-radius: 8px; }
</style>
</head>
<body>
<div class="container animate__animated animate__fadeInDown">

    <!-- Header with Admin Login/Logout -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fa-solid fa-hand-holding-heart"></i> Community Needs</h1>
        <div>
            {% if is_admin %}
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-warning me-2">
                    <i class="fa-solid fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-danger">
                    <i class="fa-solid fa-right-from-bracket"></i> Logout
                </a>
            {% else %}
                <a href="{{ url_for('admin_login') }}" class="btn btn-primary">
                    <i class="fa-solid fa-user-shield"></i> Admin Login
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Add Need Form -->
    <div class="card mb-4 animate__animated animate__fadeInUp">
        <div class="card-body">
            <form method="POST" action="/add">
                <input type="text" name="author" class="form-control mb-2" placeholder="Your Name" required>
                <textarea name="need" class="form-control mb-2" placeholder="Describe your need" required></textarea>
                <input type="text" name="location" id="locationInput" class="form-control mb-2" placeholder="Enter Location" required>
                <input type="text" name="category" class="form-control mb-2" placeholder="Category (optional)">
                <input type="hidden" name="lat" id="lat">
                <input type="hidden" name="lng" id="lng">
                <button type="submit" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i> Submit Need</button>
            </form>
        </div>
    </div>

    <!-- Map -->
    <div id="map" class="animate__animated animate__fadeInUp"></div>

    <!-- Needs List -->
    <h3>Current Needs</h3>
    {% for need in needs %}
        <div class="card mb-2">
            <div class="card-body">
                <h5>{{ need.author }} {% if need.completed %} <span class="badge bg-success">Completed</span> {% endif %}</h5>
                <p>{{ need.need }}</p>
                <p>Category: {{ need.category }} | Location: {{ need.location }} | Assigned: {{ need.assigned_to or "None" }}</p>
                {% if not need.completed %}
                    <form action="{{ url_for('complete_need', need_id=need.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-outline-success">Mark Completed</button>
                    </form>
                {% endif %}
                {% if is_admin %}
                    <form action="{{ url_for('delete_need', need_id=need.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                    </form>
                {% endif %}
            </div>
        </div>
    {% endfor %}

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([13.356, 74.781], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// Auto-update hidden lat/lng when typing location
document.getElementById('locationInput').addEventListener('change', function() {
    var loc = this.value;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${loc}`)
        .then(response => response.json())
        .then(data => {
            if(data.length > 0){
                var lat = parseFloat(data[0].lat);
                var lng = parseFloat(data[0].lon);
                document.getElementById('lat').value = lat;
                document.getElementById('lng').value = lng;
                map.setView([lat,lng], 15);
                L.marker([lat,lng]).addTo(map).bindPopup("Your Location: " + loc).openPopup();
            }
        });
});

// Plot needs
var needs = {{ needs|tojson }};
needs.forEach(function(n){
    L.circleMarker([n.lat, n.lng], {color:'red', radius:8, fillOpacity:0.8})
    .addTo(map)
    .bindPopup("<b>"+n.need+"</b><br>"+n.author+"<br>Assigned: "+(n.assigned_to||"None"));
});

// Plot providers
var providers = {{ providers|tojson }};
providers.forEach(function(p){
    L.circleMarker([p.lat, p.lng], {color:'blue', radius:6, fillOpacity:0.8})
    .addTo(map)
    .bindPopup("Provider: "+p.name+"<br>Available: "+p.available);
});
</script>
</body>
</html>
